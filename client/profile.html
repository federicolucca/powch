<!DOCTYPE html>
<html>
	<head>
		<title>PoWch</title>
        
        <link rel="stylesheet" type="text/css" href="lib/bootstrap/css/bootstrap.min.css"/>
        <link rel="stylesheet" type="text/css" href="css/powch.css"/>
        <link rel="stylesheet" type="text/css" href="css/profile.css"/>
        
        <script type="text/javascript" src="lib/jquery.min.js"></script>
        <script type="text/javascript" src="lib/bootstrap/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="lib/chart.min.js"></script>
        <script type="text/javascript" src="js/jolie-client.js"></script>
        <script>
            
            var currentContract,
                suggestionData,
                consumptionData,
                remainingChallenges,
                remainingAdvice;
            
            window.onload = function() {
                var request = {token: sessionStorage.token};
                currentContract = sessionStorage.contract;
                $("#username").html(sessionStorage.username);
                $("#store").click(function() {
                                    window.location.href = "store.html";
                                  });
                
                console.log("Token: " + sessionStorage.token);
                
                JolieClient.getChallenges(request, onGotChallenges, onError);
                JolieClient.getAdvice(request, onGotAdvice, onError);
                JolieClient.getPointCount(request, onGotPoints, onError);
                JolieClient.getContracts(request, onGotContracts, onError);
                // displayContract({label: "Apartment"});
            };
            
            function displayContract(contract) {
                var contractButton = $("#hidden-contract").clone();
                $(contractButton).click(function() {
                              sessionStorage.contractId = contract.id;
                              if (contract.users.length > 0) {
                              sessionStorage.contractUsers = JSON.stringify(contract.users);
                              } else {
                              sessionStorage.contractUsers = contract.users[0];
                              }
                              window.location.href = "contract.html";
                              });
                contractButton.html(contract.label);
                contractButton.css("display", "inline-block");
                $("#contracts-div").append(contractButton);
            }
            
            // Callback functions
            function onGotContracts(response) {
                var contracts = response.contracts;
                for (var i = 0; i < contracts.length; i++) {
                    displayContract(contracts[i]);
                }
            }
            
            function onGotPoints(response) {
                $("#point-count").html("x " + response.count);
            }
            
            function onGotChallenges(response) {
                remainingChallenges = response.message.length;
                $("#challenges").click(function() {
                                       console.log(response);
                                       console.log(response.message);
                                        console.log();
                                       $("#challenges-message").html(response.message[0].content);
                                       $("#challenge-modal").modal("show");
                                       });
                $("#challenges").html("Challenges (" + remainingChallenges+ ")");
            }
            
            function onGotAdvice(response) {
                advice = response.message.length;
                $("#advice").click(function() {
                                       $("#advice").html("Advice (" + remainingAdvice + ")");
                                       console.log();
                                       $("#advice-message").html(response.message[0].content);
                                       $("#advice-modal").modal("show");
                                       });
                $("#advice").html("Advice (" + response.message.length + ")");
            }
            
            function onError(error) {
                console.log(error);
            }
            
            </script>
    </head>
	<body>
        
        <div id="contents">
            <div id="nav-top" class="navbar navbar-fixed-top center">
                <div class="navbar-inner">
                    <a class="brand">PoWch</a>
                </div>
            </div>
            <!--div id="contracts-div">
                <div class="btn-group">
                    <a class="btn btn-large dropdown-toggle" data-toggle="dropdown" href="#">
                        Contracts
                        <span class="caret"></span>
                    </a>
                    <ul id="contract-dropdown" class="dropdown-menu">
                    </ul>
                </div>
            </div-->
            
            <div id="user-info">
                <div id="profile">
                    <img id="profile-img" src="img/default-profile.png"></img>
                    <h4 id="username"></h4>
                    <div id="points-div">
                        <img id="powch" src="img/powch-mini.png"></img>
                        <h4 id="point-count">x 0000</h4>
                    </div>
                </div>
            </div>
            
            <div id="contracts-div" class="side-div">
                <button id="hidden-contract" class="btn btn-large proto-contract" type="button">
                    House
                </button>
            </div>
            
            <div id="misc-div" class="side-div">
                <button id="challenges" class="btn btn-large" type="button">
                    Challenges
                </button>
                
                <button id="advice" class="btn btn-large" type="button">
                    Advice
                </button>
                
                <button id="store" class="btn btn-large" type="button">
                    Store
                </button>
                
                <button id="invoices" class="btn btn-large" type="button">
                    Invoices
                </button>
            </div>
            
            <div class="navbar navbar-fixed-bottom">
                <div class="navbar-inner">
                </div>
            </div>
        </div>
        
        <!-- Modals -->
        <div id="challenge-modal" class="modal hide fade in">
            <div class="modal-header">
                <a class="close" data-dismiss="modal">
                    <i class="icon-remove-circle"></i>
                </a>

                <h3>
                    Challenges
                </h3>
                
            </div>
            <div id="challenges-message" class="modal-body">
            </div>
            <div class="modal-footer">
                <a href="#" id="close-feedback" class="btn btn-small" data-dismiss="modal">Close</a>
            </div>
        </div>
        
        <div id="advice-modal" class="modal hide fade in">
            <div class="modal-header">
                <a class="close" data-dismiss="modal">
                    <i class="icon-remove-circle"></i>
                </a>
                
                <h3>
                    Advice
                </h3>
                
            </div>
            <div id="advice-message" class="modal-body">
            </div>
            <div class="modal-footer">
                <a href="#" id="close-feedback" class="btn btn-small" data-dismiss="modal">Close</a>
            </div>
        </div>
        
    </body>
</html>

